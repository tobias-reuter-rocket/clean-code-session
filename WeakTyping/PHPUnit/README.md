# Weak typing and assertEquals

Please run the tests one after another.

## AssertEquals_Version1_Test

- run the test, all is fine
- Uncomment the line ```\\ $result['something'] = 'which makes it brake';```
- you will see more than just one issue now

You will notice that some cases slip trough your test if assertEquals is used.
This is not a bug in PHPUnit. It is just PHP's weak typing which can cause some trouble and should be handled with care.

## AssertEquals_Version2_Test

- run the test
- it is failing with a longish error message, not as handy as the diff output of assertEquals

AssertSame is quite inconvenient regarding its output.
There are actually more issues with that, check the Experiment below for details.

## AssertEquals_Version3_Test

- run the test
- it is failing with one precise error message
- Uncomment the line ```\\ $result['something'] = 'which makes it brake';```
- run the test, it is now failing with a comfortable diff output

This seem to give us a mix of comfort and detail. But it is just a hack. 

## AssertEquals_Version4_Test

This version is just adding a similar diff feature to assertSame.
It is hacking the PHPUnit core and is just a prototype.
I think this topic should be properly addressed in PHPUnit and we should make a contribution to it.

# Experiment

Weak typing has an effect to our test quality. The following experiment shows the impact on real life code.

We are going to replace all assertEquals with assertSame calls for all unit tests.

Before:

```
bin/robo test:unit
 [Testing\PHPUnit] Running PHPUnit  --testsuite=unit --log-junit=build/logs/unit.junit.xml
PHPUnit 4.8.26 by Sebastian Bergmann and contributors.

Runtime:	PHP 5.6.27-0+deb8u1
Configuration:	/vagrant/phpunit.xml.dist

.............................................................   61 / 3090 (  1%)
.............................................................  122 / 3090 (  3%)
................................................F.F..........  183 / 3090 (  5%)
.............................................................  244 / 3090 (  7%)
.............................................................  305 / 3090 (  9%)
.............................................................  366 / 3090 ( 11%)
.............................................................  427 / 3090 ( 13%)
.............................................................  488 / 3090 ( 15%)
..R..........................................................  549 / 3090 ( 17%)
.............................................................  610 / 3090 ( 19%)
.............................................................  671 / 3090 ( 21%)
.............................................................  732 / 3090 ( 23%)
.............................................................  793 / 3090 ( 25%)
.............................................................  854 / 3090 ( 27%)
.............................................................  915 / 3090 ( 29%)
.............................................................  976 / 3090 ( 31%)
............................................................. 1037 / 3090 ( 33%)
............................................................. 1098 / 3090 ( 35%)
............................................................. 1159 / 3090 ( 37%)
............................................................. 1220 / 3090 ( 39%)
............................................................. 1281 / 3090 ( 41%)
............................................................. 1342 / 3090 ( 43%)
............................................................. 1403 / 3090 ( 45%)
............................................................. 1464 / 3090 ( 47%)
............................................................. 1525 / 3090 ( 49%)
............................................................. 1586 / 3090 ( 51%)
............................................................. 1647 / 3090 ( 53%)
............................................................. 1708 / 3090 ( 55%)
............................................................. 1769 / 3090 ( 57%)
............................................................. 1830 / 3090 ( 59%)
............................................................. 1891 / 3090 ( 61%)
............................................................. 1952 / 3090 ( 63%)
............................................................. 2013 / 3090 ( 65%)
............................................................. 2074 / 3090 ( 67%)
............................................................. 2135 / 3090 ( 69%)
............................................................. 2196 / 3090 ( 71%)
..................I..II.......II............................. 2257 / 3090 ( 73%)
............................................................. 2318 / 3090 ( 75%)
............................................................. 2379 / 3090 ( 76%)
............................................................. 2440 / 3090 ( 78%)
............................................................. 2501 / 3090 ( 80%)
............................................................. 2562 / 3090 ( 82%)
............................................................. 2623 / 3090 ( 84%)
............................................................. 2684 / 3090 ( 86%)
............................................................. 2745 / 3090 ( 88%)
............................................................. 2806 / 3090 ( 90%)
............................................................. 2867 / 3090 ( 92%)
............................................................. 2928 / 3090 ( 94%)
............................................................. 2989 / 3090 ( 96%)
............................................................. 3050 / 3090 ( 98%)
........................................

Time: 11.89 seconds, Memory: 181.00MB
```

After:

```
bin/robo test:unit
 [Testing\PHPUnit] Running PHPUnit  --testsuite=unit --log-junit=build/logs/unit.junit.xml
PHPUnit 4.8.26 by Sebastian Bergmann and contributors.

Runtime:	PHP 5.6.27-0+deb8u1
Configuration:	/vagrant/phpunit.xml.dist

...............F.............................................   61 / 3090 (  1%)
.............................................................  122 / 3090 (  3%)
................................................F.F..........  183 / 3090 (  5%)
................................F............................  244 / 3090 (  7%)
........................................................F....  305 / 3090 (  9%)
.............................................................  366 / 3090 ( 11%)
.F...................................................F.......  427 / 3090 ( 13%)
..............................F..............................  488 / 3090 ( 15%)
..R......F...................................................  549 / 3090 ( 17%)
.............................................................  610 / 3090 ( 19%)
............F................................................  671 / 3090 ( 21%)
....................................F...............F........  732 / 3090 ( 23%)
F.F........FFFFFF......................................F.FF..  793 / 3090 ( 25%)
........................................F....................  854 / 3090 ( 27%)
..FF.........................................................  915 / 3090 ( 29%)
.............................................................  976 / 3090 ( 31%)
............................................................. 1037 / 3090 ( 33%)
.................F........................................... 1098 / 3090 ( 35%)
............................................................. 1159 / 3090 ( 37%)
.................................F........................... 1220 / 3090 ( 39%)
.......................................F..................... 1281 / 3090 ( 41%)
...............................F............................. 1342 / 3090 ( 43%)
..........FF.........F.F...............F........F....FF...FF. 1403 / 3090 ( 45%)
...............................F............................. 1464 / 3090 ( 47%)
............................................................. 1525 / 3090 ( 49%)
.........................................FF.................. 1586 / 3090 ( 51%)
............................................................. 1647 / 3090 ( 53%)
...................................................FFF.F..... 1708 / 3090 ( 55%)
....FF..F...FFFFF.F...........................F.............. 1769 / 3090 ( 57%)
............................................................. 1830 / 3090 ( 59%)
...................................F......FFFF............FF. 1891 / 3090 ( 61%)
........................................F.F..F............... 1952 / 3090 ( 63%)
..F.........F........F....................................... 2013 / 3090 ( 65%)
............................................................. 2074 / 3090 ( 67%)
......................................F.........F..F...F....F 2135 / 3090 ( 69%)
FF..FFF...................................................... 2196 / 3090 ( 71%)
..................I..II.......II.......FF.................... 2257 / 3090 ( 73%)
............FFFFF......F...................F................. 2318 / 3090 ( 75%)
............................................................. 2379 / 3090 ( 76%)
............................................................. 2440 / 3090 ( 78%)
.................F.FF...........................F........F... 2501 / 3090 ( 80%)
.........FFF.......F......................................... 2562 / 3090 ( 82%)
............................................................. 2623 / 3090 ( 84%)
............................................................. 2684 / 3090 ( 86%)
............................................................. 2745 / 3090 ( 88%)
............................................F................ 2806 / 3090 ( 90%)
.....................F....................................... 2867 / 3090 ( 92%)
........................FF.FF........FF...F...........F...... 2928 / 3090 ( 94%)
............................................F..F.F........... 2989 / 3090 ( 96%)
............................................................. 3050 / 3090 ( 98%)
........................................

Time: 10.51 seconds, Memory: 187.00MB

There were 111 failures:
```

## Looking into detail

### Case 1: Array order mismatch

```
Failed asserting that Array &0 (
    'Guest' => Array &1 ()
    'Admin' => Array &2 (
        0 => 'Guest'
        1 => 'User'
    )
    'User' => Array &3 ()
    'dummy' => Array &4 (
        0 => 'User'
    )
) is identical to Array &0 (
    'Guest' => Array &1 ()
    'User' => Array &2 ()
    'Admin' => Array &3 (
        0 => 'Guest'
        1 => 'User'
    )
    'dummy' => Array &4 (
        0 => 'User'
    )
).
```

Diff:
```diff -u diffs/Case1*```
```
 Array &0 (
     'Guest' => Array &1 ()
-    'User' => Array &2 ()
-    'Admin' => Array &3 (
+    'Admin' => Array &2 (
         0 => 'Guest'
         1 => 'User'
     )
+    'User' => Array &3 ()
     'dummy' => Array &4 (
         0 => 'User'
     )
```

Conclusion: 
The diff shows that it is just an order mismatch. The order doesn't matter in most of the cases, so it is misleading.
However, the effort to fix that order mismatch in the fixture shouldn't be a big deal.

### Case 2: Type mismatch worth investigation

```
Failed asserting that Array &0 (
    'imported_files' => Array &1 (
        0 => '/vagrant/tests/unit/Common/Config/Examples/config.ini'
    )
    'instance' => null
    'module' => null
    'section' => Array &2 (
        'ini' => 'ini'
        'num' => '10.2'
        'bool' => ''
        'string' => 'string'
        'arr' => Array &3 (
            0 => 'Lorem'
            1 => 'Ipsum'
        )
        'assoc' => Array &4 (
            'lorem' => 'Lorem'
            'ipsum' => 'Ipsum'
        )
    )
) is identical to Array &0 (
    'imported_files' => Array &1 (
        0 => '/vagrant/tests/unit/Common/Config/Examples/config.ini'
    )
    'instance' => null
    'module' => null
    'section' => Array &2 (
        'ini' => 'ini'
        'num' => 10.199999999999999
        'bool' => false
        'string' => 'string'
        'arr' => Array &3 (
            0 => 'Lorem'
            1 => 'Ipsum'
        )
        'assoc' => Array &4 (
            'lorem' => 'Lorem'
            'ipsum' => 'Ipsum'
        )
    )
).
```


Diff:
```diff -u diffs/Case2*``` 
```
     'section' => Array &2 (
         'ini' => 'ini'
-        'num' => '10.2'
-        'bool' => ''
+        'num' => 10.199999999999999
+        'bool' => false
         'string' => 'string'
         'arr' => Array &3 (
```

Conclusion:
The diff shows the common issues with weak typing. It is not necessary a bug.
- treating an empty string as false has an impact, if you go for type secure checks for example ```false === $value```
- floating number precision issues have an impact on our calculations